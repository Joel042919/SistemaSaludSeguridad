generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Enums
enum RolUsuario {
    ADMINISTRADOR
    ADMISION
    MEDICO
    LABORATORIO
    PACIENTE
    TESORERIA
    LOGISTICA
}

enum EstadoCita {
    PENDIENTE
    CONFIRMADA
    EN_ESPERA
    EN_ATENCION
    ATENDIDO
    CANCELADO
    NO_ASISTIO
}

enum TipoExamen {
    MEDICO_GENERAL
    OPTOMETRIA
    AUDIOMETRIA
    PSICOLOGIA
    FISIOTERAPIA
    LABORATORIO
    RADIOLOGIA
    ESPIROMETRIA
    ODONTOLOGIA
    RAYOS_X
    IMAGENOLOGIA
    MUSCULO_ESQUELETICO
    LABORATORIO_CLINICO
}

enum EstadoExamen {
    PENDIENTE
    EN_PROCESO
    COMPLETADO
    OBSERVADO
}

enum Aptitud {
    APTO
    APTO_CON_RESTRICCIONES
    NO_APTO
    EVALUADO
}

enum MedioPago {
    EFECTIVO
    TARJETA
    TRANSFERENCIA
    YAPE
    PLIN
}

enum EstadoPago {
    PENDIENTE
    PAGADO
    ANULADO
}

enum Moneda {
    PEN
    USD
}

// 1. Configuración y Administración
model Usuario {
    id           String     @id @default(uuid())
    email        String     @unique
    passwordHash String
    nombres      String
    apellidos    String
    dni          String?    @unique
    telefono     String?
    rol          RolUsuario
    activo       Boolean    @default(true)
    createdAt    DateTime   @default(now())
    updatedAt    DateTime   @updatedAt

    // Relaciones
    medicoPerfil           Medico?
    logs                   AuditLog[]
    facturas               Factura[]              @relation("Vendedor")
    cajas                  Caja[]
    // 10. Analítica
    reportesPersonalizados ReportePersonalizado[]
}

model Medico {
    id              String   @id @default(uuid())
    usuarioId       String   @unique
    usuario         Usuario  @relation(fields: [usuarioId], references: [id])
    especialidad    String
    cmp             String // Colegio Médico del Perú
    rne             String? // Registro Nacional de Especialista
    firmaDigitalUrl String?
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    // Relaciones
    citasAtendidas     Cita[]
    conceptosAptitud   ConceptoAptitud[]
    examenesRealizados ExamenRealizado[]
    firmaDigital       FirmaDigital?
}

model AuditLog {
    id        String   @id @default(uuid())
    usuarioId String
    usuario   Usuario  @relation(fields: [usuarioId], references: [id])
    accion    String
    entidad   String?
    entidadId String?
    detalles  Json?
    createdAt DateTime @default(now())
}

// 2. Admisiones y Gestión de Turnos
model Empresa {
    id               String   @id @default(uuid())
    ruc              String   @unique
    razonSocial      String
    direccion        String?
    contactoNombre   String?
    contactoEmail    String?
    contactoTelefono String?
    createdAt        DateTime @default(now())
    updatedAt        DateTime @updatedAt

    // Relaciones
    pacientes  Paciente[]
    protocolos Protocolo[]
}

model Paciente {
    id              String   @id @default(uuid())
    nombres         String
    apellidos       String
    tipoDoc         String   @default("DNI") // DNI, CE, PASAPORTE
    numDoc          String   @unique
    fechaNacimiento DateTime
    sexo            String
    telefono        String?
    email           String?
    direccion       String?
    puestoTrabajo   String?
    fotoUrl         String?
    huellaDigital   String? // Para identificación biométrica
    empresaId       String?
    empresa         Empresa? @relation(fields: [empresaId], references: [id])
    documentos      Json? // Estructura: [{ categoria: "DNI", url: "..." }, ...]
    createdAt       DateTime @default(now())
    updatedAt       DateTime @updatedAt

    // Relaciones
    citas     Cita[]
    historias HistoriaClinica[]
    facturas  Factura[]
}

model Protocolo {
    id         String   @id @default(uuid())
    nombre     String // Ej: "Emo Pre-Ocupacional Administrativo"
    empresaId  String
    empresa    Empresa  @relation(fields: [empresaId], references: [id])
    examenes   Json // Lista de tipos de exámenes requeridos
    precioBase Decimal  @db.Decimal(10, 2)
    activo     Boolean  @default(true)
    createdAt  DateTime @default(now())
    updatedAt  DateTime @updatedAt

    // Relaciones
    citas Cita[]
}

model Cita {
    id              String     @id @default(uuid())
    pacienteId      String
    paciente        Paciente   @relation(fields: [pacienteId], references: [id])
    protocoloId     String?
    protocolo       Protocolo? @relation(fields: [protocoloId], references: [id])
    medicoId        String?
    medico          Medico?    @relation(fields: [medicoId], references: [id])
    fechaProgramada DateTime
    fechaLlegada    DateTime?
    estado          EstadoCita @default(PENDIENTE)
    observaciones   String?
    createdAt       DateTime   @default(now())
    updatedAt       DateTime   @updatedAt

    // Relaciones
    historiaClinica HistoriaClinica?
    factura         Factura?
    seguimiento     SeguimientoLogistico?
}

// 3. Historia Clínica Ocupacional
model HistoriaClinica {
    id                      String   @id @default(uuid())
    pacienteId              String
    paciente                Paciente @relation(fields: [pacienteId], references: [id])
    citaId                  String   @unique
    cita                    Cita     @relation(fields: [citaId], references: [id])
    fechaApertura           DateTime @default(now())
    antecedentesLaborales   String?  @db.Text
    antecedentesPatologicos String?  @db.Text
    alergias                String?
    habitosNocivos          String?
    createdAt               DateTime @default(now())
    updatedAt               DateTime @updatedAt

    // Relaciones
    examenes ExamenRealizado[]
    concepto ConceptoAptitud?
}

model ExamenRealizado {
    id            String          @id @default(uuid())
    historiaId    String
    historia      HistoriaClinica @relation(fields: [historiaId], references: [id])
    tipoExamen    TipoExamen
    medicoId      String?
    medico        Medico?         @relation(fields: [medicoId], references: [id])
    resultados    Json? // Estructura flexible según examen
    archivosUrl   String[]
    estado        EstadoExamen    @default(PENDIENTE)
    conclusiones  String?         @db.Text
    observaciones String?         @db.Text
    createdAt     DateTime        @default(now())
    updatedAt     DateTime        @updatedAt
}

// 5. Módulo de Concepto de Aptitud
model ConceptoAptitud {
    id          String             @id @default(uuid())
    historiaId  String             @unique
    historia    HistoriaClinica    @relation(fields: [historiaId], references: [id])
    medicoId    String
    medico      Medico             @relation(fields: [medicoId], references: [id])
    plantillaId String?
    plantilla   PlantillaConcepto? @relation(fields: [plantillaId], references: [id])

    aptitud         Aptitud
    restricciones   String?   @db.Text
    recomendaciones String?   @db.Text
    vigenciaMeses   Int?
    fechaEmision    DateTime  @default(now())
    fechaVigencia   DateTime?

    // Seguridad Digital
    firmado          Boolean @default(false)
    hashVerificacion String? @unique // SHA-256 del contenido
    pdfGenerado      String? // URL o path del PDF final
    firmaImagenUrl   String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    auditorias AuditoriaConcepto[]
}

model PlantillaConcepto {
    id                   String   @id @default(uuid())
    nombre               String
    contenidoHtml        String   @db.Text
    variablesDisponibles Json? // Ejp: ["nombre_paciente", "dni", "fecha"]
    tipoResultado        Aptitud? // Si es null, aplica para cualquiera
    activo               Boolean  @default(true)
    createdAt            DateTime @default(now())
    updatedAt            DateTime @updatedAt

    conceptos ConceptoAptitud[]
}

model FirmaDigital {
    id                 String   @id @default(uuid())
    medicoId           String   @unique
    medico             Medico   @relation(fields: [medicoId], references: [id])
    certificadoDigital Bytes? // Archivo .p12 o similar (simulado)
    hashCertificado    String?
    passwordHash       String? // Password para desbloquear firma
    activo             Boolean  @default(true)
    updatedAt          DateTime @updatedAt
}

model AuditoriaConcepto {
    id         String          @id @default(uuid())
    conceptoId String
    concepto   ConceptoAptitud @relation(fields: [conceptoId], references: [id])
    usuarioId  String
    accion     String // "EMISION", "DESCARGA", "VERIFICACION"
    ip         String?
    userAgent  String?
    createdAt  DateTime        @default(now())
}

// 6. Facturación y Tesorería
model Factura {
    id         String    @id @default(uuid())
    citaId     String?   @unique
    cita       Cita?     @relation(fields: [citaId], references: [id])
    pacienteId String?
    paciente   Paciente? @relation(fields: [pacienteId], references: [id])
    usuarioId  String // Quién emitió la factura (Cajero)
    usuario    Usuario   @relation("Vendedor", fields: [usuarioId], references: [id])

    // Datos SUNAT
    tipoComprobante String // 01=FACTURA, 03=BOLETA
    serie           String
    numero          String
    fechaEmision    DateTime @default(now())
    moneda          Moneda   @default(PEN)

    // Cliente
    clienteNombre    String
    clienteDoc       String
    clienteDireccion String?

    // Montos
    subtotal   Decimal    @db.Decimal(10, 2)
    igv        Decimal    @db.Decimal(10, 2)
    total      Decimal    @db.Decimal(10, 2)
    estadoPago EstadoPago @default(PENDIENTE)

    // SUNAT Response
    xmlGenerado  String? @db.Text
    cdrRespuesta String? @db.Text
    hashCdr      String?
    estadoSunat  String? @default("PENDIENTE") // ENVIADO, ACEPTADO, RECHAZADO

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    detalles FacturaDetalle[]
    pagos    Pago[]

    @@unique([serie, numero])
}

model FacturaDetalle {
    id             String  @id @default(uuid())
    facturaId      String
    factura        Factura @relation(fields: [facturaId], references: [id])
    descripcion    String
    cantidad       Decimal @db.Decimal(10, 2)
    precioUnitario Decimal @db.Decimal(10, 2)
    subtotal       Decimal @db.Decimal(10, 2)
}

model Pago {
    id         String    @id @default(uuid())
    facturaId  String
    factura    Factura   @relation(fields: [facturaId], references: [id])
    medioPago  MedioPago
    monto      Decimal   @db.Decimal(10, 2)
    referencia String? // Nro operación, etc.
    fechaPago  DateTime  @default(now())

    // Relación con Caja (Para saber en qué turno entró el dinero)
    cajaId String?
    caja   Caja?   @relation(fields: [cajaId], references: [id])
}

model Caja {
    id            String    @id @default(uuid())
    usuarioId     String // Cajero responsable
    usuario       Usuario   @relation(fields: [usuarioId], references: [id])
    nombre        String // "Caja 1", "Caja Principal"
    montoApertura Decimal   @db.Decimal(10, 2)
    montoCierre   Decimal?  @db.Decimal(10, 2)
    fechaApertura DateTime  @default(now())
    fechaCierre   DateTime?
    estado        String    @default("ABIERTA") // ABIERTA, CERRADA

    movimientos    MovimientoCaja[]
    pagosRecibidos Pago[]
}

model MovimientoCaja {
    id          String   @id @default(uuid())
    cajaId      String
    caja        Caja     @relation(fields: [cajaId], references: [id])
    tipo        String // INGRESO, EGRESO
    monto       Decimal  @db.Decimal(10, 2)
    descripcion String
    usuarioId   String // Quien registra
    createdAt   DateTime @default(now())
}

model PasarelaPago {
    id        String  @id @default(uuid())
    nombre    String  @unique // "CULQI", "IZIPAY"
    apiKey    String
    apiSecret String?
    activo    Boolean @default(true)
}

model Conciliacion {
    id            String   @id @default(uuid())
    fecha         DateTime @default(now())
    totalSistema  Decimal  @db.Decimal(10, 2)
    totalBanco    Decimal  @db.Decimal(10, 2)
    diferencia    Decimal  @db.Decimal(10, 2)
    observaciones String?
    usuarioId     String
}

// --- INVENTARIO & LOGÍSTICA ---

model Proveedor {
    id          String                 @id @default(uuid())
    ruc         String                 @unique
    razonSocial String
    telefono    String?
    email       String?
    direccion   String?
    items       InventarioItem[]
    movimientos MovimientoInventario[]
    createdAt   DateTime               @default(now())
    updatedAt   DateTime               @updatedAt
}

model InventarioItem {
    id          String  @id @default(uuid())
    codigo      String  @unique // SKU o Código de Barras
    nombre      String
    descripcion String?
    categoria   String // MEDICAMENTO, INSUMO, EPP, REACTIVO

    // Stock
    stockActual  Decimal  @default(0) @db.Decimal(10, 2)
    stockMinimo  Decimal  @default(0) @db.Decimal(10, 2)
    stockMaximo  Decimal? @db.Decimal(10, 2)
    unidadMedida String // UNIDAD, CAJA, LITRO, ML

    // Costos y Precios
    costoPromedio Decimal  @default(0) @db.Decimal(10, 2)
    precioVenta   Decimal? @db.Decimal(10, 2)

    // Lotes y Vencimiento (Control FIFO/FEFO se hace por lógica, aquí datos generales del último o trazabilidad)
    ubicacion String? // Estante A1

    proveedorId String?
    proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])

    movimientos MovimientoInventario[]
    kardex      Kardex[]
    alertas     AlertaInventario[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model MovimientoInventario {
    id            String         @id @default(uuid())
    itemId        String
    item          InventarioItem @relation(fields: [itemId], references: [id])
    tipo          String // INGRESO, SALIDA, AJUSTE
    cantidad      Decimal        @db.Decimal(10, 2)
    costoUnitario Decimal?       @db.Decimal(10, 2) // Para ingresos
    costoTotal    Decimal?       @db.Decimal(10, 2)

    motivo           String? // Compra, Venta, Caducidad, Merma
    documentoRef     String? // Nro Guía, Factura
    lote             String?
    fechaVencimiento DateTime?

    proveedorId String?
    proveedor   Proveedor? @relation(fields: [proveedorId], references: [id])

    usuarioId String
    createdAt DateTime @default(now())

    kardex Kardex[]
}

model Kardex {
    id           String               @id @default(uuid())
    itemId       String
    item         InventarioItem       @relation(fields: [itemId], references: [id])
    movimientoId String
    movimiento   MovimientoInventario @relation(fields: [movimientoId], references: [id])

    fecha DateTime @default(now())
    tipo  String // ENTRADA, SALIDA

    // Valores históricos post-movimiento
    cantidad      Decimal @db.Decimal(10, 2) // Saldo Cantidad
    costoUnitario Decimal @db.Decimal(10, 2) // Costo Promedio en ese momento
    costoTotal    Decimal @db.Decimal(10, 2) // Saldo Valorado
}

model AlertaInventario {
    id        String         @id @default(uuid())
    itemId    String
    item      InventarioItem @relation(fields: [itemId], references: [id])
    tipo      String // STOCK_BAJO, VENCIMIENTO, STOCK_EXCESIVO
    mensaje   String
    leido     Boolean        @default(false)
    createdAt DateTime       @default(now())
}

model SeguimientoLogistico {
    id     String @id @default(uuid())
    citaId String @unique
    cita   Cita   @relation(fields: [citaId], references: [id])

    estadoActual    String // MUESTRA_TOMADA, EN_CAMINO, EN_LABORATORIO, PROCESANDO, INFORME_DISPONIBLE
    ubicacionActual String? // "Laboratorio Central", "Recepción"
    fechaEstimada   DateTime?

    historial HistorialLogistica[]

    updatedAt DateTime @updatedAt
}

model HistorialLogistica {
    id            String               @id @default(uuid())
    seguimientoId String
    seguimiento   SeguimientoLogistico @relation(fields: [seguimientoId], references: [id])

    estado      String
    ubicacion   String?
    usuarioId   String // Quien actualizó
    observacion String?
    timestamp   DateTime @default(now())
}

// 8. Configuración del Sistema
model Configuracion {
    id            String   @id @default(uuid())
    nombreClinica String   @default("Salud Laboral")
    ruc           String?
    direccion     String?
    logoUrl       String?
    apiSunatUser  String?
    apiSunatPass  String?
    updatedAt     DateTime @updatedAt
}

// 9. Gestión de Plantillas
model Plantilla {
    id          String   @id @default(uuid())
    titulo      String
    contenido   String   @db.Text
    tipo        String // Ej: "CONSENTIMIENTO", "INFORME"
    rutaArchivo String? // Ruta local o URL del archivo
    activo      Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
}

// 10. Módulo de Analítica
model ReportePersonalizado {
    id            String   @id @default(uuid())
    titulo        String
    tipo          String // Ej: "FINANCIERO", "MEDICO", "OPERATIVO"
    configuracion Json // Filtros aplicados, columnas seleccionadas, tipo de gráfico
    usuarioId     String
    usuario       Usuario  @relation(fields: [usuarioId], references: [id])
    createdAt     DateTime @default(now())
}
